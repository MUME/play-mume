/*! For license information please see decafmud.display.standard.js.LICENSE.txt */
!function(t){var s=function(t,s,e){t.addEventListener?t.addEventListener(s,e,!1):(s="on"+s,t.attachEvent?t.attachEvent(s,e):t[s]=e)},e=function(e,i,l){this.decaf=e,this.ui=i,this._display=l,this.display=document.createElement("div"),this.display.className="decafmud display "+this.decaf.options.set_display.fgclass+"7",this._display.appendChild(this.display);var r=this;s(this._display,"scroll",function(t){r.onScroll()}),s(this._display,"mousedown",function(t){2===t.which&&r.decaf.store.get("ui/middle-click-scroll",!1)&&(r.scroll(),t.cancelBubble&&(t.cancelBubble=!0),t.preventDefault())}),this.decaf.loaded_plugs.display=this,this.splash=this.display.innerHTML,this.orig_title=null,this.clear(),this.message('<br><a href="https://github.com/MUME/DecafMUD">DecafMUD</a> v'+t.version+' by Stendec &lt;<a href="mailto:stendec365@gmail.com">stendec365@gmail.com</a>&gt;<br>'),this.splash.length>0&&this.message(this.splash+"<br>")},i=parseInt("00000001",2),l=parseInt("00000010",2),r=parseInt("00000100",2),a=parseInt("00001000",2),n=parseInt("00010000",2),o=parseInt("00100000",2),h=parseInt("01000000",2),c=parseInt("10000000",2);e.prototype.state=0,e.prototype.c_fg=7,e.prototype.c_bg=0,e.prototype.c_fnt=0,e.prototype.readyClear=!1,e.prototype.endSpace=!1,e.prototype.scrollTime=null,e.prototype.willScroll=!1,e.prototype.vt100Warning=!1,e.prototype.mxp=!1,e.prototype.clear=function(){clearTimeout(this.scrollTime),this.display.innerHTML="",this.reset(),this.inbuf=[],this.outbuf=[]},e.prototype.reset=function(){this.state=0,this.c_fg=7,this.c_bg=0,this.c_fnt=0,this.readyClear=!1,this.endSpace=!1},e.prototype.sbw=void 0,e.prototype.scrollbarWidth=function(){if(this.sbw)return this.sbw;var t=this._display.style.overflowY;return this._display.style.overflowY="scroll",this._display.offsetWidth>this._display.clientWidth?(this.sbw=this._display.offsetWidth-this._display.clientWidth,this.sbw):(this._display.style.overflowY=t,15)},e.prototype.cz=void 0,e.prototype.charSize=function(){if(this.cz)return this.cz;var t=document.createElement("span");t.innerHTML="W",this.display.appendChild(t);var s=t.offsetWidth,e=t.offsetHeight;return this.display.removeChild(t),this.cz=[s,e],this.cz},e.prototype.getSize=function(){var t;t=this.decaf.options.set_display.scrollbarwidth?this.decaf.options.set_display.scrollbarwidth:this.scrollbarWidth();var s=this._display.clientWidth-t,e=this._display.clientHeight,i=this.charSize(),l=i[0],r=i[1];return[Math.floor(s/l)+1,Math.floor(e/r)]},e.prototype.handleData=function(t){this.inbuf.push(t),this.processData()},e.prototype.processData=function(){if(!(this.inbuf.length<1)){var s=this.inbuf.join("");this.inbuf=[];for(var e=t.ESC;s.length>0;){var i=s.indexOf(e);if(-1===i){this.outbuf.push(s.replace(/</g,"&lt;"));break}i>0&&(this.readyClear=!1,this.outbuf.push(s.substr(0,i).replace(/</g,"&lt;")),s=s.substr(i));var l=this.readANSI(s);if(!1===l){this.inbuf.push(s);break}s=l}s=this.outbuf.join(""),this.outbuf=[],this.outColor(!1),this.needline=!s.endsWith("\n"),this._display.setAttribute("aria-busy",!0);var r=document.createElement("span");r.innerHTML=s.replace(/\n\r?/g,"<br>").replace(/> /g,">&nbsp;").replace(/ ( +)/g,function(t){return 2===t.length?" &nbsp;":" "+new Array(t.length-1).join("&nbsp;")+" "}),this.shouldScroll(),this.display.appendChild(r),this.doScroll(),this.truncateLines()}},e.prototype.truncateLines=function(){if(this.display.clientHeight<window.innerHeight*this.decaf.options.set_display.maxscreens||this.display.children.length<this.decaf.options.set_display.minelements)return;let t=0,s=[],e=this.display.clientHeight-window.innerHeight*this.decaf.options.set_display.maxscreens;for(;t<e&&this.display.children.length>s.length;)t+=this.display.children[s.length].offsetHeight,s.push(this.display.children[s.length]);s.forEach(t=>t.remove())},e.prototype.readANSI=function(s){if(s.length<2)return!1;if("["==s.charAt(1))return-1!==(e=s.substr(2).search(/[\x40-\x7E]/))&&(e+=2,this.handleAnsiCSI(s.substr(2,e-1)),s.substr(e+1));if("]"==s.charAt(1)){var e=s.substr(2).indexOf(t.BEL),i=s.substr(2).indexOf(t.ESC+"\\");return(i<e||-1===e)&&(e=i),-1!==e&&(e+=2,s.substr(e))}return s.substr(1)},e.prototype.handleAnsiCSI=function(t){switch(t.charAt(t.length-1)){case"m":var s=this.state,e=this.c_fg,p=this.c_bg,d=this.c_fnt;1===t.length&&(t="0m");for(var u=t.substr(0,t.length-1).split(";"),f=u.length,g=0;g<f;g++){var y=parseInt(u[g]);if(38===y){if(g++,++g>=f)break;this.c_fg=parseInt(u[g])}else if(39===y)this.c_fg=7;else if(48===y){if(g++,++g>=f)break;this.c_bg=parseInt(u[g])}else{if(29<y&&y<38){this.c_fg=y-30;continue}if(39<y&&y<48){this.c_bg=y-40;continue}if(0===y){this.state=0,this.c_fg=7,this.c_bg=0,this.c_fnt=0;continue}if(1===y){this.state|=i,this.state&=~o;continue}if(2===y)this.state&=~i,this.state|=o;else if(3===y)this.state|=r;else if(4===y)this.state|=n,this.state&=~c;else if(y<7)this.state|=a;else if(7===y)this.state|=l;else{if(8===y)continue;9===y?this.state|=h:y<20?this.c_fnt=y-10:21===y?(this.state|=c,this.state&=~n):22===y?this.state&=~(i|o):23===y?this.state&=~r:24===y?this.state&=~(n|c):25===y?this.state&=~a:27===y?this.state&=~l:29===y?this.state&=~h:49===y?this.c_bg=0:89<y&&y<98?(this.state|=i,this.state&=~o,this.c_fg=y-90):99<y&&y<108&&(this.c_bg=y-92)}}}return this.state===s&&e===this.c_fg&&p===this.c_bg&&d===this.c_fnt||this.outColor(),void(this.readyClear=!1);case"@":case"C":var b=1;return t.length>1&&(b=parseInt(t.substr(0,t.length-1))),this.outbuf.push(new Array(b+1).join(" ")),void(this.readyClear=!1);case"E":return b=1,t.length>1&&(b=parseInt(t.substr(0,t.length-1))),this.outbuf.push(new Array(b+1).join("\n")),void(this.readyClear=!1);case"H":return void(1===t.length&&(this.readyClear=!0));case"J":var _=0;return t.length>1&&(_=parseInt(t.substr(0,t.length-1))),(0===_&&this.readyClear||2===_)&&this.clear(),void(this.readyClear=!1);case"K":if(_=0,t.length>1&&(_=parseInt(t.substr(0,t.length-1))),2===_){var v=!1;if(this.outbuf.length>0)for(;this.outbuf.length>0;){var m=this.outbuf[this.outbuf.length-1];if(-1!==m.lastIndexOf("\n")){v=!0,this.outbuf[this.outbuf.length-1]=m.substr(0,m.lastIndexOf("\n")+1);break}this.outbuf.pop()}if(!v)for(;this.display.childElementCount>0;){var T=this.display.children[this.display.childElementCount-1],S=T.innerHTML;if(-1!==S.lastIndexOf("<br>")){v=!0,T.innerHTML=S.substr(0,S.lastIndexOf("<br>")+4);break}this.display.removeChild(T)}}else 1===_&&this.decaf.debugString("ANSI Sequence ESC ["+t+" -- TODO: Mode 1");return}-1!=="ABCDEFGHJKSTfnsulh".indexOf(t.charAt(t.length-1))?this.vt100Warning||(this.decaf.debugString("Notice: This display handler only provides a subset of VT100, and doesn't handle cursor movement commands."),this.vt100Warning=!0):this.decaf.debugString("Unhandled ANSI Sequence: ESC ["+t)},e.prototype.outColor=function(t,s){var e,p=this.c_fg,d=this.c_bg,u=this.state,f=this.decaf.options.set_display;if(u&i&&p<8&&(p+=8),e=(!1!==t?"</span>":"")+'<span class="',u&r&&(e+="italic "),u&a&&(e+="blink "),u&n&&(e+="underline "),u&c&&(e+="doubleunderline "),u&o&&(e+="faint "),u&h&&(e+="strike "),u&l&&(d=p,p=this.c_bg),0!==this.c_fnt&&(e+=f.fntclass+this.c_fnt+" "),7!==p&&(e+=f.fgclass+p+" "),0!==d&&(e+=f.bgclass+d),e+='">',!0===s)return e;this.outbuf.push(e)},e.prototype.message=function(t,s,e){void 0===s&&(s="message");var i=document.createElement("span");this.needline&&!1!==e&&(i.innerHTML="<br>"),this.needline=!1,i.innerHTML+=t.replace(/ ( +)/g,function(t){return 2===t.length?" &nbsp;":" "+new Array(t.length-1).join("&nbsp;")+" "})+"<br>",this.shouldScroll(),this.display.appendChild(i),this.doScroll()},e.prototype.shouldScroll=function(t){if(void 0===this.willScroll&&"hidden"!==this._display.style.overflowY&&(this.willScroll=this._display.scrollTop+1>=this._display.scrollHeight-this._display.offsetHeight,!1!==t&&!1===this.willScroll&&!this.scrollTarget)){var s=document.createElement("hr");s.className="scroll-point",this.scrollTarget=s,this.display.appendChild(s),this.ui&&this.ui.showScrollButton&&this.ui.showScrollButton()}},e.prototype.doScroll=function(){var t=this;clearTimeout(this.scrollTime),this.willScroll?this.scrollTime=setTimeout(function(){t.scrollTarget&&(t.scrollTarget.parentNode.removeChild(t.scrollTarget),t.scrollTarget=void 0),t._display.setAttribute("aria-busy",!1),t.scroll(),t.willScroll=void 0},5):this.scrollTime=setTimeout(function(){t._display.setAttribute("aria-busy",!1),t.willScroll=void 0},5)},e.prototype.scrollNew=function(){if(this.scrollTarget){var t=this.scrollTarget.offsetTop;t>this._display.scrollTop?this._display.scrollTop=t:this.scroll()}},e.prototype.scroll=function(){"hidden"!==this._display.style.overflowY&&(this._display.scrollTop=this._display.scrollHeight)},e.prototype.onScroll=function(){void 0!==this.scrollTarget&&this._display.scrollTop>=this._display.scrollHeight-this._display.offsetHeight&&(this.scrollTarget&&(this.scrollTarget.parentNode.removeChild(this.scrollTarget),this.scrollTarget=void 0),this.ui&&this.ui.hideScrollButton&&this.ui.hideScrollButton())},e.prototype.scrollUp=function(){var t=this._display.scrollTop-this._display.clientHeight;t<0&&(t=0),this._display.scrollTop=t},e.prototype.scrollDown=function(){var t=this._display.scrollTop+this._display.clientHeight;this._display.scrollTop=t},e.prototype.tags={VAR:{default:!0,secure:!0,want:!0,open_tag:"",close_tag:"",arg_order:["name","desc","private","publish","delete","add","remove"],arguments:{name:"",desc:"",private:!1,publish:!0,delete:!1,add:!0,remove:!1},handler:function(){}},B:{default:!0,secure:!1,want:!1,open_tag:'<b class="mxp">',close_tag:"</b>"},BOLD:"B",STRONG:"B",I:{default:!0,secure:!1,want:!1,open_tag:'<i class="mxp">',close_tag:"</i>"},ITALIC:"I",EM:"I",U:{default:!0,secure:!1,want:!1,open_tag:'<u class="mxp">',close_tag:"</u>"},UNDERLINE:"U",S:{default:!0,secure:!1,want:!1,open_tag:'<s class="mxp">',close_tag:"</s>"},STRIKEOUT:"S",COLOR:{default:!0,secure:!1,want:!1,open_tag:'<span class="mxp mxp-color" style="color:&fore;;background-color:&back;">',close_tag:"</span>",arg_order:["fore","back"],arguments:{fore:"inherit",back:"inherit"}},C:"COLOR",HIGH:{default:!0,secure:!1,want:!0}},t.plugins.Display.standard=e}(DecafMUD);